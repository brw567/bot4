#!/bin/bash
# Git pre-commit hook - Prevents committing fake implementations

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "Running pre-commit quality checks..."

# Check for unimplemented!() in staged files
UNIMPLEMENTED=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' | xargs grep -l 'unimplemented!' 2>/dev/null)
if [ ! -z "$UNIMPLEMENTED" ]; then
    echo -e "${RED}✗ ERROR: Found unimplemented!() in:${NC}"
    echo "$UNIMPLEMENTED"
    echo -e "${YELLOW}Remove or implement before committing.${NC}"
    exit 1
fi

# Check for todo!() in staged files
TODO=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' | xargs grep -l 'todo!' 2>/dev/null)
if [ ! -z "$TODO" ]; then
    echo -e "${RED}✗ ERROR: Found todo!() in:${NC}"
    echo "$TODO"
    echo -e "${YELLOW}Complete implementation before committing.${NC}"
    exit 1
fi

# Check for fake/mock in production code
MOCKS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' | grep -v test | xargs grep -l -E 'mock|Mock|fake|Fake|dummy|Dummy' 2>/dev/null)
if [ ! -z "$MOCKS" ]; then
    echo -e "${YELLOW}⚠ WARNING: Found potential mock implementations in:${NC}"
    echo "$MOCKS"
    echo "Verify these are not fake implementations."
    read -p "Continue anyway? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for hardcoded values
HARDCODED=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' | xargs grep -l 'price.*\*.*0\.0[0-9]' 2>/dev/null)
if [ ! -z "$HARDCODED" ]; then
    echo -e "${YELLOW}⚠ WARNING: Found potential hardcoded calculations in:${NC}"
    echo "$HARDCODED"
    echo "Verify these are legitimate calculations."
fi

# Run basic compilation check
echo "Checking compilation..."
if ! cargo check --all 2>/dev/null; then
    echo -e "${RED}✗ ERROR: Code does not compile${NC}"
    echo "Fix compilation errors before committing."
    exit 1
fi

# Check if marking task as complete
if git diff --cached PROJECT_MANAGEMENT_TASK_LIST_V4.md | grep -q "✅ COMPLETED"; then
    echo -e "${YELLOW}Detected task marked as COMPLETED${NC}"
    echo "Running full verification..."
    
    if ! ./scripts/verify_completion.sh; then
        echo -e "${RED}✗ Task verification failed${NC}"
        echo "Cannot mark task as complete until all checks pass."
        exit 1
    fi
fi

echo -e "${GREEN}✓ All pre-commit checks passed${NC}"
exit 0